

# **Making unit sources from contours defining the earthquake source geometry**
------------------------------------------------------------------------------

*Note: Do not edit the tutorial.md file directly, as it is auto-generated by the
corresponding tutorial.Rmd file. Edit the latter instead.*

# Background

This document explains how to use the script
*'[produce_unit_sources.R](produce_unit_sources.R)'* to convert earthquake
source contours (defining an irregularly dipping surface on which earthquake
slip can occur) into unit sources. It also provides some explanation
of the data structures used.

You may find it helpful to directly read
*'[produce_unit_sources.R](produce_unit_sources.R)'* first (or instead),
particularly if you have programming experience. All functions used therein are
documented in the rptha package or other packages, and so R's help system can
be consulted for details. 

In a typical application you would make a copy of *'[produce_unit_sources.R](produce_unit_sources.R)'* in a
new working directory, and then edit the script parameters as required before
running. You might also edit the code, depending on your needs.

To create a set of unit sources, you first need to have a set of source
contours. These describe the earthquake source geometry, which we will
discretize into unit sources. The source contours need to be in line shapefile
format, where each line corresponds to a contour with given depth. The actual
depths are stored in the shapefile attribute table, with an attribute name
'level' giving the depth in km.  Lon-lat coordinates should be used (WGS84).

The source contours will be used to define the unit sources, so they should
only cover areas where you want unit sources to be made. On a typical
subduction zone they would extend from the subduction zone trench to a depth
of around 50 km, though the latter depth may vary (see e.g.  Berryman et al.,
2015). 

The unit sources will be arranged in a logically rectangular grid which covers
the source contours. The number of unit-sources down-dip and along-strike is chosen
based on the user-provided value for the desired unit-source length and width. 

# Example data

In this example we work with some contours for the Alaska source-zone. This is
situated at the eastern end of the Aleutians-Alaska subduction interface in the
North Pacific. The code below demonstrates how to read them in R and make a basic plot. 

**Note the code in this section is not required when using
*'[produce_unit_sources.R](produce_unit_sources.R)'* -- however, we include
this to demonstrate the input data requirements**


```r
# Read the shapefile
library(rgdal)
```

```
## Loading required package: methods
## Loading required package: sp
## rgdal: version: 1.0-4, (SVN revision 548)
##  Geospatial Data Abstraction Library extensions to R successfully loaded
##  Loaded GDAL runtime: GDAL 1.10.1, released 2013/08/26
##  Path to GDAL shared files: /usr/share/gdal/1.10
##  Loaded PROJ.4 runtime: Rel. 4.8.0, 6 March 2012, [PJ_VERSION: 480]
##  Path to PROJ.4 shared files: (autodetected)
##  Linking to sp version: 1.1-1
```

```r
alaska = readOGR(dsn='CONTOURS/alaska.shp', layer='alaska')
```

```
## OGR data source with driver: ESRI Shapefile 
## Source: "CONTOURS/alaska.shp", layer: "alaska"
## with 10 features
## It has 1 fields
```

```r
# Print some information about it
alaska
```

```
## An object of class "SpatialLinesDataFrame"
## Slot "data":
##    level
## 0      6
## 1     16
## 2     21
## 3     26
## 4     31
## 5     36
## 6     41
## 7     46
## 8     51
## 9 55.999
## 
## Slot "lines":
## [[1]]
## An object of class "Lines"
## Slot "Lines":
## [[1]]
## An object of class "Line"
## Slot "coords":
##          [,1]     [,2]
## [1,] 215.5272 59.54571
## [2,] 214.1744 58.95917
## [3,] 213.2280 58.34240
## [4,] 212.2017 57.62460
## [5,] 210.9808 57.01440
## [6,] 209.5834 56.53390
## [7,] 208.1152 56.14440
## [8,] 206.8280 55.60710
## 
## 
## 
## Slot "ID":
## [1] "0"
## 
## 
## [[2]]
## An object of class "Lines"
## Slot "Lines":
## [[1]]
## An object of class "Line"
## Slot "coords":
##           [,1]     [,2]
##  [1,] 214.8914 59.83469
##  [2,] 214.5913 59.81667
##  [3,] 214.3913 59.78669
##  [4,] 213.6913 59.56007
##  [5,] 213.2913 59.39131
##  [6,] 213.0913 59.29026
##  [7,] 212.8484 59.13479
##  [8,] 212.3577 58.73479
##  [9,] 212.1913 58.62490
## [10,] 211.8913 58.49026
## [11,] 211.1300 58.23479
## [12,] 210.7913 58.08905
## [13,] 210.4913 57.91190
## [14,] 210.1385 57.63479
## [15,] 209.9913 57.53747
## [16,] 209.6913 57.39072
## [17,] 208.5913 56.98238
## [18,] 207.6913 56.71636
## [19,] 206.0648 56.16128
## 
## 
## 
## Slot "ID":
## [1] "1"
## 
## 
## [[3]]
## An object of class "Lines"
## Slot "Lines":
## [[1]]
## An object of class "Line"
## Slot "coords":
##           [,1]     [,2]
##  [1,] 214.2812 60.04492
##  [2,] 214.0913 59.97128
##  [3,] 213.4913 59.78572
##  [4,] 212.9200 59.53479
##  [5,] 212.5612 59.33479
##  [6,] 212.0533 58.93479
##  [7,] 211.7913 58.79595
##  [8,] 211.5913 58.72760
##  [9,] 211.2913 58.65444
## [10,] 210.6913 58.56206
## [11,] 210.3913 58.46407
## [12,] 210.2913 58.40411
## [13,] 210.1913 58.31387
## [14,] 210.0269 58.03479
## [15,] 209.8495 57.83479
## [16,] 209.6913 57.71384
## [17,] 209.4913 57.60811
## [18,] 209.2913 57.52906
## [19,] 208.4913 57.27688
## [20,] 208.0913 57.18069
## [21,] 207.4913 57.07665
## [22,] 207.1913 56.99717
## [23,] 206.8913 56.89279
## [24,] 205.9913 56.50671
## [25,] 205.7155 56.41059
## 
## 
## 
## Slot "ID":
## [1] "2"
## 
## 
## [[4]]
## An object of class "Lines"
## Slot "Lines":
## [[1]]
## An object of class "Line"
## Slot "coords":
##           [,1]     [,2]
##  [1,] 213.9983 60.22785
##  [2,] 213.5913 60.10589
##  [3,] 213.0913 59.92527
##  [4,] 212.3069 59.53479
##  [5,] 211.7913 59.21567
##  [6,] 211.4913 59.07630
##  [7,] 211.1913 59.00448
##  [8,] 210.1913 59.00228
##  [9,] 209.9913 58.98046
## [10,] 209.8391 58.93479
## [11,] 209.6913 58.84306
## [12,] 209.6189 58.73479
## [13,] 209.5882 58.63479
## [14,] 209.5641 58.23479
## [15,] 209.5433 58.13479
## [16,] 209.4990 58.03479
## [17,] 209.4139 57.93479
## [18,] 209.2666 57.83479
## [19,] 208.8913 57.68256
## [20,] 208.3913 57.53138
## [21,] 207.9913 57.45497
## [22,] 207.1133 57.33479
## [23,] 206.7157 57.23479
## [24,] 206.2740 57.03479
## [25,] 205.4401 56.58607
## 
## 
## 
## Slot "ID":
## [1] "3"
## 
## 
## [[5]]
## An object of class "Lines"
## Slot "Lines":
## [[1]]
## An object of class "Line"
## Slot "coords":
##           [,1]     [,2]
##  [1,] 213.5437 60.38246
##  [2,] 213.0563 60.23479
##  [3,] 212.2913 59.86706
##  [4,] 211.3913 59.54637
##  [5,] 210.9913 59.46241
##  [6,] 209.9913 59.35896
##  [7,] 209.5913 59.25868
##  [8,] 209.4913 59.20769
##  [9,] 209.4011 59.13479
## [10,] 209.3218 59.03479
## [11,] 209.2728 58.93479
## [12,] 209.2512 58.83479
## [13,] 209.1898 58.33479
## [14,] 209.0812 58.13479
## [15,] 208.9778 58.03479
## [16,] 208.8913 57.98230
## [17,] 208.5913 57.86673
## [18,] 208.0913 57.73265
## [19,] 207.6913 57.66723
## [20,] 206.7913 57.55896
## [21,] 206.4913 57.49207
## [22,] 206.2913 57.41640
## [23,] 206.0913 57.30774
## [24,] 205.4913 56.88835
## [25,] 205.2011 56.72499
## 
## 
## 
## Slot "ID":
## [1] "4"
## 
## 
## [[6]]
## An object of class "Lines"
## Slot "Lines":
## [[1]]
## An object of class "Line"
## Slot "coords":
##           [,1]     [,2]
##  [1,] 213.1075 60.61865
##  [2,] 212.6913 60.50400
##  [3,] 212.4913 60.40978
##  [4,] 212.1812 60.23479
##  [5,] 211.9350 60.13479
##  [6,] 211.3913 60.01236
##  [7,] 210.7913 59.92232
##  [8,] 210.1913 59.80131
##  [9,] 209.7913 59.68735
## [10,] 209.4913 59.56802
## [11,] 209.2588 59.43479
## [12,] 209.1446 59.33479
## [13,] 209.0913 59.25683
## [14,] 208.9936 59.03479
## [15,] 208.9652 58.93479
## [16,] 208.9215 58.53479
## [17,] 208.8913 58.45012
## [18,] 208.8224 58.33479
## [19,] 208.6913 58.21432
## [20,] 208.5449 58.13479
## [21,] 208.3913 58.07959
## [22,] 207.6913 57.87860
## [23,] 207.3913 57.82574
## [24,] 206.5913 57.74122
## [25,] 206.1503 57.63479
## [26,] 205.9415 57.53479
## [27,] 205.3913 57.08057
## [28,] 205.1913 56.94741
## [29,] 204.9837 56.84237
## 
## 
## 
## Slot "ID":
## [1] "5"
## 
## 
## [[7]]
## An object of class "Lines"
## Slot "Lines":
## [[1]]
## An object of class "Line"
## Slot "coords":
##           [,1]     [,2]
##  [1,] 204.8049 56.93479
##  [2,] 204.9913 57.01890
##  [3,] 205.1745 57.13479
##  [4,] 205.3063 57.23479
##  [5,] 205.7372 57.63479
##  [6,] 205.8913 57.73217
##  [7,] 205.9913 57.77407
##  [8,] 206.3913 57.88042
##  [9,] 207.4913 58.05067
## [10,] 208.0913 58.23672
## [11,] 208.3913 58.37430
## [12,] 208.4913 58.43862
## [13,] 208.5913 58.54195
## [14,] 208.6590 58.73479
## [15,] 208.6834 58.93479
## [16,] 208.7865 59.33479
## [17,] 208.8913 59.49692
## [18,] 209.0214 59.63479
## [19,] 209.4913 59.93536
## [20,] 209.6913 60.04827
## [21,] 209.8913 60.13631
## [22,] 210.2913 60.27061
## [23,] 211.0913 60.49037
## [24,] 211.2913 60.57033
## [25,] 211.4040 60.63479
## [26,] 211.5080 60.73479
## [27,] 211.8013 61.13479
## 
## 
## 
## Slot "ID":
## [1] "6"
## 
## 
## [[8]]
## An object of class "Lines"
## Slot "Lines":
## [[1]]
## An object of class "Line"
## Slot "coords":
##           [,1]     [,2]
##  [1,] 211.0757 61.45045
##  [2,] 210.8913 61.42098
##  [3,] 210.7974 61.33479
##  [4,] 210.7112 61.13479
##  [5,] 210.6475 61.03479
##  [6,] 210.4441 60.83479
##  [7,] 209.2913 60.12575
##  [8,] 208.9913 59.92159
##  [9,] 208.7587 59.73479
## [10,] 208.6647 59.63479
## [11,] 208.5969 59.53479
## [12,] 208.4963 59.33479
## [13,] 208.4543 59.13479
## [14,] 208.3186 58.73479
## [15,] 208.2551 58.63479
## [16,] 208.1295 58.53479
## [17,] 207.8913 58.41402
## [18,] 207.4913 58.28217
## [19,] 206.9913 58.15813
## [20,] 206.1913 57.98899
## [21,] 205.8913 57.89812
## [22,] 205.7600 57.83479
## [23,] 205.5913 57.71886
## [24,] 205.1913 57.34142
## [25,] 204.9913 57.18712
## [26,] 204.6971 57.02905
## 
## 
## 
## Slot "ID":
## [1] "7"
## 
## 
## [[9]]
## An object of class "Lines"
## Slot "Lines":
## [[1]]
## An object of class "Line"
## Slot "coords":
##           [,1]     [,2]
##  [1,] 210.5005 61.72566
##  [2,] 210.2937 61.53479
##  [3,] 210.0332 61.13479
##  [4,] 209.6824 60.73479
##  [5,] 209.3531 60.43479
##  [6,] 208.6913 59.93971
##  [7,] 208.4913 59.74320
##  [8,] 208.4129 59.63479
##  [9,] 208.3062 59.43479
## [10,] 208.0906 58.93479
## [11,] 208.0316 58.83479
## [12,] 207.9386 58.73479
## [13,] 207.6913 58.59396
## [14,] 207.1913 58.40439
## [15,] 206.6913 58.24646
## [16,] 205.9913 58.07254
## [17,] 205.6913 57.95508
## [18,] 205.4913 57.81760
## [19,] 205.1913 57.52417
## [20,] 204.9693 57.33479
## [21,] 204.7913 57.21088
## [22,] 204.6083 57.11786
## 
## 
## 
## Slot "ID":
## [1] "8"
## 
## 
## [[10]]
## An object of class "Lines"
## Slot "Lines":
## [[1]]
## An object of class "Line"
## Slot "coords":
##           [,1]     [,2]
##  [1,] 210.1986 61.83479
##  [2,] 209.9913 61.67199
##  [3,] 209.8577 61.53479
##  [4,] 209.4658 60.93479
##  [5,] 209.2300 60.63479
##  [6,] 209.0325 60.43479
##  [7,] 208.5424 60.03479
##  [8,] 208.3524 59.83479
##  [9,] 208.2082 59.63479
## [10,] 207.8913 59.04453
## [11,] 207.7913 58.92588
## [12,] 207.6717 58.83479
## [13,] 207.4925 58.73479
## [14,] 206.8913 58.47386
## [15,] 206.4951 58.33479
## [16,] 205.8913 58.17067
## [17,] 205.5913 58.04751
## [18,] 205.4319 57.93479
## [19,] 205.2444 57.73479
## [20,] 204.8913 57.42482
## [21,] 204.6913 57.28614
## [22,] 204.4529 57.17327
## 
## 
## 
## Slot "ID":
## [1] "9"
## 
## 
## 
## Slot "bbox":
##        min       max
## x 204.4529 215.52723
## y  55.6071  61.83479
## 
## Slot "proj4string":
## CRS arguments:
##  +proj=longlat +datum=WGS84 +no_defs +ellps=WGS84 +towgs84=0,0,0
```

```r
# There should be a single attribute named 'level' containing the contour depths
names(alaska)
```

```
## [1] "level"
```

```r
print(alaska$level)
```

```
##  [1] 6      16     21     26     31     36     41     46     51     55.999
## Levels: 16 21 26 31 36 41 46 51 55.999 6
```

```r
# The print out above shows that R has read 'level' as a factor (a categorical
# type variable). Let's convert it to numeric
alaska$level = as.numeric(as.character(alaska$level))
print(alaska$level) # No longer a factor
```

```
##  [1]  6.000 16.000 21.000 26.000 31.000 36.000 41.000 46.000 51.000 55.999
```

```r
# Make a quick plot of the input data
spplot(alaska, main='Alaska sourcezone contours giving the interface depth in km', 
    scales=list(draw=TRUE), aspect='iso')
```

![plot of chunk unnamed-chunk-2](figure/unnamed-chunk-2-1.png) 

# Input parameters

The code below comes directly from *'[produce_unit_sources.R](produce_unit_sources.R)'*.

In typical usage of *'[produce_unit_sources.R](produce_unit_sources.R)'*, the user would edit the input
parameters to define the source contour filename(s), the desired unit-source
length and width, the resolution of the output raster, and some numerical
parameters describing the density of sub-unit-source gridpoints inside each unit
source.

Note that more than one source-contour shapefile can be provided -- the code
will loop over them.

If you are running linux on a shared memory machine with multiple cores, then
you can run in parallel by setting MC_CORES to be a number greater than one. In this
case each core will run separate unit sources, until all are completed. 


```r
# Main 'driver' script to create the unit sources (currently pure thrust events
# only)
#
# Gareth Davies, Geoscience Australia 2015
#
library(rptha)
```

```
## Loading required package: rgeos
## rgeos version: 0.3-15, (SVN revision 515)
##  GEOS runtime version: 3.4.2-CAPI-1.8.2 r3921 
##  Linking to sp version: 1.1-1 
##  Polygon checking: TRUE 
## 
## Loading required package: geosphere
## Loading required package: raster
## Loading required package: FNN
## Loading required package: minpack.lm
## Loading required package: geometry
## Loading required package: magic
## Loading required package: abind
## 
## Attaching package: 'magic'
## 
## The following object is masked from 'package:raster':
## 
##     shift
```

```r
###############################################################################
#
# Main input parameters 
#
###############################################################################

# A vector with shapefile names for all contours that we want to convert to
# unit sources
all_sourcezone_shapefiles = Sys.glob('./CONTOURS/*.shp') # Matches all shapefiles in CONTOURS

# Desired unit source geometric parameters
desired_subfault_length = 100 # km
desired_subfault_width = 50 # km

# Desired spacing of sub-unit-source points
# Lower values (e.g. 1000) may be required for accuracy in unit sources
# along the trench, but in deeper unit sources a coarser point spacing
# can be used. Hence 2 different values are provided.
# The computational effort approximately scales with the inverse square of
# the point density. 
shallow_subunitsource_point_spacing = 1000 # m
deep_subunitsource_point_spacing = 6000 #m

# For computational efficiency, only compute the okada deformation at
# distances <= okada_distance_factor x (depth of sub-unit-source point) 
# This can save computational effort for shallow unit sources.
# But be careful if using a wide subunitsource_point_spacing.
okada_distance_factor = 50 # Inf 

# Cell size for output rasters
tsunami_source_cellsize = 1/60 # degrees

# Number of cores for parallel parts. Values > 1 will only work on shared
# memory linux machines.
MC_CORES = 12 

# Option to illustrate 3d interactive plot creation
#
# Only make the 3d interactive plot if you can use interactive graphics and
# have rgl (i.e. use FALSE on NCI). 
make_3d_interactive_plot = FALSE 
```

# Outputs

If the code successfully runs, it will generate: 
* a set of tiff files (one for each unit source) with the computed tsunami deformation. 
* a pdf file for each sourcezone, with various plots that can be used to check
that the unit sources and tsunami deformations seem sensible.
* an RDS file for each sourcezone. This is a native R format file, and contains
the tsunami unit sources as a native R data-structure. It can be useful for
programming, since it contains the underlying data (such as sub-unit-source
points, exact unit source discretization, etc).

<!---
# Geometric discretization

Here we create the unit source geometry. The computation of the tsunami
deformation comes later. The key step is the function call
*discretized_source_from_source_contours* which converts source contours
to a list of unit sources.




The above figures illustrate that the source contours are converted to a logically
retangular grid of unit sources.

# Further exploration of the data structures

Here we explore the unit source data structures in more detail. Perhaps the
most important point is that the unit source grid is stored as a 3d array.


```r
# discretized_sources is a list containing unit source information for each sourcezone.
length(discretized_sources) # Should be equal to the number of input shapefiles
```

```
## Error in eval(expr, envir, enclos): object 'discretized_sources' not found
```

```r
names(discretized_sources)
```

```
## Error in eval(expr, envir, enclos): object 'discretized_sources' not found
```

```r
# Taking the example of alaska, we look at the unit source information for a single source
names(discretized_sources$alaska)
```

```
## Error in eval(expr, envir, enclos): object 'discretized_sources' not found
```

```r
# The depth contours are as before
plot(discretized_sources$alaska$depth_contours, asp=1, axes=TRUE)
```

```
## Error in plot(discretized_sources$alaska$depth_contours, asp = 1, axes = TRUE): error in evaluating the argument 'x' in selecting a method for function 'plot': Error: object 'discretized_sources' not found
```

```r
# The unit sources are in a grid of these dimensions down-dip and along-strike 
discretized_sources$alaska$discretized_source_dim
```

```
## Error in eval(expr, envir, enclos): object 'discretized_sources' not found
```

```r
ndip = discretized_sources$alaska$discretized_source_dim['dip']
```

```
## Error in eval(expr, envir, enclos): object 'discretized_sources' not found
```

```r
nstrike = discretized_sources$alaska$discretized_source_dim['strike']
```

```
## Error in eval(expr, envir, enclos): object 'discretized_sources' not found
```

```r
# The unit source grid is represented as a 3d array of x,y,depth points. These
# define the boundaries of the unit sources. Obviously there must be 'ndip+1'
# lines down dip, and 'nstrike+1' lines along-strike
#
# First dimension: Down-dip
# Second dimension: x,y,z
# Third dimension: Along-strike
#
dim(discretized_sources$alaska$unit_source_grid)
```

```
## Error in eval(expr, envir, enclos): object 'discretized_sources' not found
```

```r
discretized_sources$alaska$unit_source_grid
```

```
## Error in eval(expr, envir, enclos): object 'discretized_sources' not found
```

```r
# Add to the plot
for(j in 1:(nstrike+1)) points(discretized_sources$alaska$unit_source_grid[,1:2,j], t='o', col='red')
```

```
## Error in eval(expr, envir, enclos): object 'nstrike' not found
```

```r
for(j in 1:(ndip+1)) points(t(discretized_sources$alaska$unit_source_grid[j,1:2,]), t='o', col='red')
```

```
## Error in eval(expr, envir, enclos): object 'ndip' not found
```


# Tsunami deformation

Finally we compute the tsunami initial condition for each unit source.



--->
